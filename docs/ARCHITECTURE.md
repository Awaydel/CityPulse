# 🏗️ Архитектура проекта EcoSense

## Обзор системы

EcoSense — это full-stack приложение для мониторинга качества воздуха, построенное по архитектуре **ETL → Data Warehouse → Dashboard**.

---

## Диаграмма потоков данных

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ВНЕШНИЕ ИСТОЧНИКИ                                 │
│  ┌─────────────────────────┐    ┌─────────────────────────┐                 │
│  │  Open-Meteo Weather API │    │  Open-Meteo Air Quality │                 │
│  └───────────┬─────────────┘    └───────────┬─────────────┘                 │
└──────────────┼──────────────────────────────┼───────────────────────────────┘
               │                              │
               └──────────────┬───────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ETL PIPELINE (Python)                               │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                   │
│  │   EXTRACT    │───►│  TRANSFORM   │───►│     LOAD     │                   │
│  │  requests    │    │ Pandas + ML  │    │   psycopg2   │                   │
│  └──────────────┘    └──────────────┘    └──────┬───────┘                   │
└─────────────────────────────────────────────────┼───────────────────────────┘
                                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      DATA WAREHOUSE (PostgreSQL)                            │
│  ┌──────────────┐    ┌──────────────┐    ┌────────────────────┐             │
│  │   dim_city   │    │ fact_weather │    │  fact_air_quality  │             │
│  └──────┬───────┘    └──────┬───────┘    └─────────┬──────────┘             │
│         │                   │                      │                        │
│         └───────────────────┴──────────────────────┘                        │
│                             │                                               │
│                             ▼                                               │
│                ┌────────────────────────┐                                   │
│                │ dm_dashboard_analytics │                                   │
│                │        (VIEW)          │                                   │
│                └───────────┬────────────┘                                   │
└────────────────────────────┼────────────────────────────────────────────────┘
                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         BACKEND (FastAPI)                                   │
│                    ┌──────────────────────┐                                 │
│                    │      REST API        │                                 │
│                    │  /api/cities         │                                 │
│                    │  /api/measurements   │                                 │
│                    └──────────┬───────────┘                                 │
└───────────────────────────────┼─────────────────────────────────────────────┘
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         FRONTEND (React)                                    │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                   │
│  │  Dashboard   │    │  QA Report   │    │ Data Registry│                   │
│  └──────────────┘    └──────────────┘    └──────────────┘                   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Компоненты системы

### 1. ETL Pipeline (`services/etl.py`)

| Этап | Описание | Технологии |
|------|----------|------------|
| **Extract** | Получение данных из Open-Meteo API (погода + качество воздуха) | `requests` |
| **Transform** | Объединение данных, очистка, обучение ML-модели | `pandas`, `scikit-learn` |
| **Load** | Загрузка в PostgreSQL с поддержкой UPSERT | `psycopg2` |

**ML-компонент:** Linear Regression для прогнозирования PM2.5 на основе температуры, влажности и скорости ветра.

---

### 2. Data Warehouse (PostgreSQL)

#### Схема «Звезда» (Star Schema)

```
                    ┌──────────────┐
                    │   dim_city   │
                    │──────────────│
                    │ city_id (PK) │
                    │ name         │
                    │ country_code │
                    │ latitude     │
                    │ longitude    │
                    └──────┬───────┘
                           │
           ┌───────────────┼───────────────┐
           │               │               │
           ▼               │               ▼
┌──────────────────┐       │    ┌──────────────────────┐
│   fact_weather   │       │    │  fact_air_quality    │
│──────────────────│       │    │──────────────────────│
│ city_id (FK)     │◄──────┘───►│ city_id (FK)         │
│ timestamp        │            │ timestamp            │
│ temperature      │            │ pm10                 │
│ humidity         │            │ pm25                 │
│ wind_speed       │            │ predicted_pm25       │
└──────────────────┘            └──────────────────────┘
```

#### Представление (VIEW)

`dm_dashboard_analytics` — денормализованное представление для дашборда, объединяющее все таблицы.

---

### 3. Backend (`server.py`)

| Endpoint | Метод | Описание |
|----------|-------|----------|
| `/` | GET | Health check |
| `/api/cities` | GET | Список городов из `dim_city` |
| `/api/measurements` | GET | Данные измерений для города |

**Технологии:** FastAPI, Uvicorn, CORS middleware.

---

### 4. Frontend (`App.tsx`)

| Модуль | Компонент | Описание |
|--------|-----------|----------|
| Dashboard | `TrendsChart` | Графики PM2.5/PM10 с AI-прогнозом |
| Dashboard | `CorrelationMatrix` | Матрица корреляций параметров |
| Dashboard | `TrueHeatmap` | Тепловая карта по дням/часам |
| QA Report | Встроенный | Метрики качества данных |
| Data | Таблица | Реестр измерений |
| Logs | Встроенный | Системные логи |

**Технологии:** React 19, TypeScript, Recharts, Lucide Icons.

---

## Ключевые архитектурные решения

1. **Разделение ETL и API** — ETL запускается отдельно, API только читает данные из БД.
2. **Star Schema** — упрощает аналитические запросы и JOIN'ы.
3. **ML в ETL** — модель обучается при каждом запуске ETL, прогнозы сохраняются в БД.
4. **SPA Frontend** — React приложение работает через REST API.

---

## Развёртывание

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Frontend  │────►│   Backend   │────►│  PostgreSQL │
│  (Vite Dev) │     │  (Uvicorn)  │     │   Database  │
│  :5173      │     │  :8000      │     │   :5432     │
└─────────────┘     └─────────────┘     └─────────────┘
```

Все компоненты запускаются локально. Для production рекомендуется:
- Frontend: Nginx + статические файлы
- Backend: Gunicorn + Uvicorn workers
- Database: Managed PostgreSQL
