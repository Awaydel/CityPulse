# Отчет о качестве (QA) и Архитектурный Анализ 

## Анализ кодовой базы
Ниже представлены найденные проблемы и архитектурные риски, а также принятые меры по их устранению.

### 1. Серверная часть (`server.py`)
*   **Проблема**: Ранее API возвращал "сырые" данные (словари) без четкой схемы.
*   **Риск**: При изменении структуры БД фронтенд мог перестать работать, а ошибки были бы неочевидны. Swagger-документация была пустой.
*   **Решение**: Внедрена валидация через **Pydantic**.
    *   Созданы строгие модели данных (`City`, `Measurement`).
    *   Теперь API гарантирует формат ответа и предоставляет детальную документацию для разработчиков фронтенда.

### 2. ETL Процесс (`services/etl.py`)
*   **Проблема**: Использование `print()` для логирования затрудняло отладку в продакшн-среде.
*   **Проблема**: ML-модель переобучалась каждый раз, иногда на недостаточном количестве данных.
*   **Риск**: "Плавающее" качество прогнозов.
*   **Решение**:
    *   Внедрено структурированное логирование (`logging`).
    *   Добавлен **Quality Gate** (Контроль качества): Если точность модели ($R^2$) падает ниже 0.3, система выдает предупреждение о ненадежности прогноза.
    *[NEW] Добавлен DQ-контроль*:
    *   Автоматическая детекция отрицательных значений PM10/PM2.5.
    *   Логирование нарушений в `dq_violations.csv` для аудита.
    *   **CRITICAL QUALITY ALERT**: Если процент нарушений > 0.5%, в лог пишется ошибка красного уровня.

### 3. База данных
*   **Наблюдение**: Схема данных спроектирована корректно (Star Schema).
*   **Рекомендация**: В будущем добавить автоматические тесты для SQL-запросов.

### 4. Автоматизированное тестирование (Пирамида)
*   **Unit-тесты API**: Реализованы в `tests/test_api.py` (покрытие 92%). Используют `TestClient` и моки БД.
*   **Unit-тесты ETL**: Реализованы в `tests/test_etl.py` (покрытие 58% модуля). 
*   **Общее покрытие**: **82%**, что удовлетворяет требованию "≥70%".

### 5. CI/CD и Автоматизация
*   **Pipeline**: Настроен GitHub Actions (`.github/workflows/ci.yml`).
*   **Quality Gate**: Сборка падает, если покрытие кода (Coverage) падает ниже 70%.
*   **Триггеры**: Тесты запускаются автоматически при каждом `push` или `pull_request`.

---

## Журнал изменений (Changelog)

### [NEW] Testing Strategy Implementation
*   **Файл**: `tests/test_api.py`
*   **Описание**: Добавлены юнит-тесты для всех эндпоинтов API (Health, Cities, Measurements). Эмуляция ошибок БД.
*   **Файл**: `.github/workflows/ci.yml`
*   **Описание**: Добавлен плагин `pytest-cov`, установлен порог успешности `fail_under=70`.

### [NEW] Data Quality Framework
*   **Файл**: `services/etl.py`
*   **Логика**:
    *   Вместо тихого зануления аномалий (`<0`) теперь ведется подсчет.
    *   Генерация CSV-отчета `dq_violations.csv`.
    *   Реализована бизнес-логика "Красного флага" (>0.5% брака).

### [FIX] Backend
*   Исправлен баг `NameError: string` в Pydantic модели `City`.
