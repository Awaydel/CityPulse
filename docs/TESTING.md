# TESTING.md: Стратегия Тестирования и Контроль Качества Данных
============================================================

## 1. Стратегия Тестирования (Пирамида)
--------------------------------------
Проект использует автоматизированную пирамиду тестов (Раздел 5), адаптированную для Data Engineering:

*   **Unit-тесты (База):** Проверка ключевой логики (нормализация единиц, расчет лагов).
*   **Интеграционные тесты:** API-клиенты, запись в БД.
*   **End-to-End тесты:** Проверка сквозного сценария: API -> Витрина -> Дашборд.
*   **Тесты Качества Данных (DQ):** Встроены в Airflow DAG на этапе `validate`.

## 2. Детализация Тестов Качества Данных (DQ)
-------------------------------------------

DQ-проверки критичны для витрины и выполняются на каждом ежечасном или ежедневном запуске ETL.

### 2.1. DQ-1: Валидность Временных Мето к (Монотонность)

*   **Требование:** Временные ряды должны быть монотонны (нет скачков назад, нет дубликатов `timestamp`).
*   **Обоснование:** Дубликаты или пропуски нарушат расчет скользящих средних.
*   **Отчетность:** Логирование факта обнаружения.

### 2.2. DQ-2: Разумные Диапазоны Значений (PM2.5)

*   **Требование:** Концентрация PM2.5 должна находиться в строгом диапазоне **[0; 999] μg/m³**.
*   **Действие при нарушении:** Запись отбрасывается.
*   **Красный Флаг:** Если доля отброшенных записей превышает **0.5%** от общего объема, инициировать Alert.

### 2.3. DQ-3: Целостность Внешних Ключей

*   **Требование:** Каждая запись в Fact-таблице должна ссылаться на существующую запись в Dim-таблице.
*   **Обоснование:** Обеспечение целостности Star Schema.

## 3. Требования к Отчетности QA (Реестр Нарушений)
------------------------------------------------

Для демонстрации контроля качества (Критерий приёмки Раздела 5) необходим **Реестр Нарушений Качества (РНК)**.

*   **Артефакт:** JSON/CSV-файл, генерируемый Airflow DAG.
*   **Содержание:** `dq_rule_id`, `violating_value`, `source_city`, `pipeline_run_id` для каждой отброшенной строки.
*   **Цель:** Обеспечить трассируемость и возможность анализа первопричин (Error Analysis).

## 4. Сценарии Приемки (Acceptance Criteria) для DQ-конвейера (P-3, P-4)
----------------------------------------------------------------------
Для обеспечения качества реализации DQ-логики (DQ-2: PM2.5 [0; 999] мкг/м³ и Отчетности РНК) будут применены следующие тестовые сценарии:

### Сценарий 1: Тест на ложное срабатывание (Positive Test)
*   **Цель:** Убедиться, что валидные данные не отбрасываются.
*   **Входные данные:** Пакет из 100 записей PM2.5, где все значения находятся в пределах [50; 250] мкг/м³.
*   **Ожидаемый результат (Выход):**
    1.  Количество записей, загруженных в `fact_air_quality`: 100.
    2.  Файл РНК **НЕ** сгенерирован (или сгенерирован пустым).
    3.  Логи Airflow показывают, что **0** записей отброшено.

### Сценарий 2: Тест на граничные нарушения (Negative Test, РНК)
*   **Цель:** Проверить, что нарушения регистрируются и отбрасываются.
*   **Входные данные:** Пакет из 100 записей, содержащий: 98 валидных записей (PM2.5=100) и **2 записи-нарушителя** (PM2.5 = 1000 и PM2.5 = -5).
*   **Ожидаемый результат (Выход):**
    1.  Количество записей, загруженных в `fact_air_quality`: 98.
    2.  Файл РНК сгенерирован и содержит **2 записи**, детализирующие нарушения DQ-2.
    3.  Логи Airflow показывают, что **2** записи отброшено.

### Сценарий 3: Тест на Красный Флаг (Threshold Alert)
*   **Цель:** Проверить срабатывание оповещения при критической доле нарушений.
*   **Входные данные:** Пакет из 1000 записей, содержащий **10 нарушителей** PM2.5 (> 999 мкг/м³).
    *   *Примечание:* 10/1000 = 1.0%, что превышает порог "Красного Флага" (0.5%).
*   **Ожидаемый результат (Выход):**
    1.  DAG успешно выполнится, но количество отброшенных записей будет 10.
    2.  Должно быть сгенерировано **автоматическое оповещение** (например, в логи Airflow на уровне `ERROR` или отправка e-mail/Slack), сигнализирующее о превышении порога DQ > 0.5%.